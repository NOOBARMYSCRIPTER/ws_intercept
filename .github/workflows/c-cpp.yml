name: Build (MSYS2 / mingw-w64)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows (MSYS2 / mingw-w64)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 and install packages
        uses: msys2/setup-msys2@v2
        with:
          update: false
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-i686-toolchain
            make
            pkg-config
            unzip
            git

      # -----------------------------
      # Build x86 core first
      # -----------------------------
      - name: Build x86 core (ws.dll + libws.a)
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW32
          PATH: /mingw32/bin:/usr/bin:/bin:/mingw64/bin
        run: |
          echo "=== Building i686 core (ws.dll + libws.a) ==="
          mkdir -p build shared plugins
          CC=i686-w64-mingw32-gcc AR=i686-w64-mingw32-ar make -C $GITHUB_WORKSPACE ws.dll -j$(nproc) || (echo "core make failed"; exit 1)

      # -----------------------------
      # Build x86 plugins
      # -----------------------------
      - name: Build x86 plugins
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW32
          PATH: /mingw32/bin:/usr/bin:/bin:/mingw64/bin
        run: |
          echo "=== Building i686 plugins ==="
          make -C $GITHUB_WORKSPACE source/plugins/ffxiv_pkt_log || true
          make -C $GITHUB_WORKSPACE source/plugins/ffxiv_pkt_log_2 || true
          make -C $GITHUB_WORKSPACE source/plugins/log || true

          # Создаём структуру out32 и копируем все нужные файлы в один дроп
          rm -rf out32 || true
          mkdir -p out32
          # копируем основной DLL
          cp -v "$GITHUB_WORKSPACE/ws.dll" out32/ 2>/dev/null || true
          # копируем плагины
          mkdir -p out32/plugins
          cp -v "$GITHUB_WORKSPACE/plugins/"*.dll out32/plugins/ 2>/dev/null || true
          # копируем shared (libws.a и т.п.)
          mkdir -p out32/shared
          cp -v "$GITHUB_WORKSPACE/shared/"* out32/shared/ 2>/dev/null || true
          # копируем build (object files) для отладки (опционально)
          mkdir -p out32/build
          cp -v "$GITHUB_WORKSPACE/build/"* out32/build/ 2>/dev/null || true

      # -----------------------------
      # Build x64 core first
      # -----------------------------
      - name: Build x64 core (ws.dll + libws.a)
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW64
          PATH: /mingw64/bin:/usr/bin:/bin:/mingw32/bin
        run: |
          echo "=== Building x86_64 core (ws.dll + libws.a) ==="
          mkdir -p build shared plugins
          CC=x86_64-w64-mingw32-gcc AR=x86_64-w64-mingw32-ar make -C $GITHUB_WORKSPACE ws.dll -j$(nproc) || (echo "core make failed"; exit 1)

      # -----------------------------
      # Build x64 plugins
      # -----------------------------
      - name: Build x64 plugins
        shell: msys2 {0}
        env:
          MSYSTEM: MINGW64
          PATH: /mingw64/bin:/usr/bin:/bin:/mingw32/bin
        run: |
          echo "=== Building x86_64 plugins ==="
          make -C $GITHUB_WORKSPACE source/plugins/ffxiv_pkt_log || true
          make -C $GITHUB_WORKSPACE source/plugins/ffxiv_pkt_log_2 || true
          make -C $GITHUB_WORKSPACE source/plugins/log || true

          # Создаём структуру out64 и копируем все нужные файлы в один дроп
          rm -rf out64 || true
          mkdir -p out64
          # копируем основной DLL
          cp -v "$GITHUB_WORKSPACE/ws.dll" out64/ 2>/dev/null || true
          # копируем плагины
          mkdir -p out64/plugins
          cp -v "$GITHUB_WORKSPACE/plugins/"*.dll out64/plugins/ 2>/dev/null || true
          # копируем shared (libws.a и т.п.)
          mkdir -p out64/shared
          cp -v "$GITHUB_WORKSPACE/shared/"* out64/shared/ 2>/dev/null || true
          # копируем build (object files) для отладки (опционально)
          mkdir -p out64/build
          cp -v "$GITHUB_WORKSPACE/build/"* out64/build/ 2>/dev/null || true

      - name: List built outputs
        shell: msys2 {0}
        run: |
          echo "=== out32 ==="
          ls -la out32 || true
          echo "=== out32/plugins ==="
          ls -la out32/plugins || true
          echo "=== out32/shared ==="
          ls -la out32/shared || true
          echo "=== out64 ==="
          ls -la out64 || true
          echo "=== out64/plugins ==="
          ls -la out64/plugins || true
          echo "=== out64/shared ==="
          ls -la out64/shared || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ws-build
          path: |
            out32/**
            out64/**
