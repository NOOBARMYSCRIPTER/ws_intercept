name: Build (MSYS2 / mingw-w64)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
    build-windows:
    name: Build on Windows (MSYS2 / mingw-w64)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSYS2 (update + install mingw toolchains)
        uses: msys2/setup-msys2@v2
        with:
          update: false
      - name: Update pacman DB and install toolchains
        shell: msys2 {0}
        run: |
          set -e
          echo "::group::pacman update (may take some time)"
          pacman -Sy --noconfirm
          pacman -Syu --noconfirm
          echo "::endgroup::"
          echo "::group::install mingw toolchains and build deps"
          pacman -S --noconfirm \
            mingw-w64-i686-toolchain \
            mingw-w64-x86_64-toolchain \
            make \
            pkg-config \
            unzip \
            git
          echo "::endgroup::"
          # Show binaries to debug
          echo "=== check installed compilers ==="
          which i686-w64-mingw32-gcc || true
          which x86_64-w64-mingw32-gcc || true
          echo "=== done ==="

      - name: Build x86 (i686)
        shell: msys2 {0}
        env:
          # гарантируем, что /mingw32/bin стоит в PATH первым
          PATH: /mingw32/bin:/usr/bin:/bin:/mingw64/bin
        run: |
          echo "=== Building i686 ==="
          uname -a

          rm -rf build || true
          mkdir -p build

          CC=i686-w64-mingw32-gcc AR=i686-w64-mingw32-ar make -C . -j$(nproc) || (echo "make failed"; exit 1)

          mkdir -p out32/plugins
          if [ -f ws.dll ]; then cp -v ws.dll out32/ || true; fi
          cp -v plugins/*.dll out32/plugins/ 2>/dev/null || true
          ls -la out32 || true

      - name: Build x64 (x86_64)
        shell: msys2 {0}
        env:
          PATH: /mingw64/bin:/usr/bin:/bin:/mingw32/bin
        run: |
          echo "=== Building x86_64 ==="
          uname -a
          rm -rf build64 || true
          mkdir -p build64
          CC=x86_64-w64-mingw32-gcc AR=x86_64-w64-mingw32-ar make -C . -j$(nproc) || (echo "make failed"; exit 1)
          mkdir -p out64/plugins
          if [ -f ws.dll ]; then cp -v ws.dll out64/ || true; fi
          cp -v plugins/*.dll out64/plugins/ 2>/dev/null || true
          ls -la out64 || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ws-build
          path: |
            out32/**
            out64/**
          path: |
            out32/**
            out64/**
