name: Build (MSYS2 / mingw-w64)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows (MSYS2 / mingw-w64)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Устанавливаем MSYS2 и пакеты mingw
      - name: Setup MSYS2 and install packages
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-i686-toolchain
            make
            pkg-config
            unzip

      # Build 32-bit (i686)
      - name: Build x86 (i686)
        shell: msys2 {0}
        run: |
          echo "=== msys2 PATH ==="
          uname -a
          printf "\n"
          # на всякий случай убрать старые билды
          rm -rf build32 || true
          mkdir -p build32
          cd build32
          # вызываем make в корне проекта, но с кросскомпилятором i686
          # если ваш Makefile принимает переменную CC/AR, мы передаём их
          CC=i686-w64-mingw32-gcc AR=i686-w64-mingw32-ar \
            make -C .. -j$(nproc)

          # копируем артефакты в build32 (подкорректируйте пути под ваш Makefile)
          mkdir -p out32/plugins
          cp -v ../ws.dll ./out32/ 2>/dev/null || true
          cp -v plugins/*.dll ./out32/plugins/ 2>/dev/null || true
          # если Makefile кладёт в build/* — скопируйте оттуда

      # Build 64-bit (x86_64)
      - name: Build x64 (x86_64)
        shell: msys2 {0}
        run: |
          rm -rf build64 || true
          mkdir -p build64
          cd build64
          CC=x86_64-w64-mingw32-gcc AR=x86_64-w64-mingw32-ar \
            make -C .. -j$(nproc)

          mkdir -p out64/plugins
          cp -v ../ws.dll ./out64/ 2>/dev/null || true
          cp -v plugins/*.dll ./out64/plugins/ 2>/dev/null || true

      # Show built files (debug)
      - name: List built outputs
        shell: msys2 {0}
        run: |
          echo "=== out32 ==="
          ls -la out32 || true
          echo "=== out64 ==="
          ls -la out64 || true

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ws-build
          path: |
            out32/**
            out64/**
